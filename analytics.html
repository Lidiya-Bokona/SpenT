<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpenT - Analytics</title>
    <link rel="icon" type="image/png" href="static/img/logo.jpg">
    <link rel="stylesheet" href="static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <nav class="navbar glass">
        <div class="logo">
            <a href="index.html"
                style="text-decoration: none; color: inherit; display:flex; align-items:center; gap:0.5rem;">
                <div class="hero-logo-animated nav-logo" style="margin:0; width:40px; height:40px;">
                    <div class="analog-clock" style="width:40px; height:40px; border-width:1px;">
                        <div class="dollar-sign" style="font-size:1rem;">$</div>
                        <div class="hand hour-hand" style="height:10px;"></div>
                        <div class="hand minute-hand" style="height:15px;"></div>
                    </div>
                </div>
                SpenT
            </a>
        </div>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <!-- Calendar not implemented yet in static plan, omitting or pointing to dash -->
            <a href="calendar.html">Calendar</a>
            <a href="analytics.html" class="active">Analytics</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="analytics-wrapper">
            <div class="dashboard-header"
                style="justify-content: space-between; align-items: flex-end; display:flex; margin-bottom: 2rem;">
                <div>
                    <h1 style="margin-bottom:0.5rem; color: var(--accent-gold);">Financial Analysis</h1>
                    <p style="color: var(--text-secondary);">Your asset allocation & performance report.</p>
                </div>
                <div style="text-align: right;">
                    <div class="filters"
                        style="display:inline-flex; gap:0.5rem; margin-bottom:1rem; background:rgba(255,255,255,0.05); padding:0.3rem; border-radius:8px;">
                        <button onclick="setRange('1d')" class="btn-filter" id="btn-1d">Today</button>
                        <button onclick="setRange('7d')" class="btn-filter active" id="btn-7d">7 Days</button>
                        <button onclick="setRange('30d')" class="btn-filter" id="btn-30d">Month</button>
                        <button onclick="setRange('365d')" class="btn-filter" id="btn-365d">Year</button>
                    </div>
                    <div>
                        <button onclick="exportReport()" class="btn btn-secondary">
                            <i class="fas fa-file-pdf" style="margin-right:0.5rem;"></i> Export Report
                        </button>
                    </div>
                </div>
            </div>

            <style>
                .btn-filter {
                    background: transparent;
                    border: none;
                    color: var(--text-secondary);
                    padding: 0.4rem 0.8rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.85rem;
                    transition: all 0.2s;
                }

                .btn-filter:hover {
                    color: var(--text-primary);
                }

                .btn-filter.active {
                    background: var(--accent-gold);
                    color: #000;
                    box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
                }

                .charts-row-2 {
                    display: grid;
                    grid-template-columns: 2fr 1fr;
                    gap: 1.5rem;
                    margin-bottom: 1.5rem;
                }

                @media (max-width: 900px) {
                    .charts-row-2 {
                        grid-template-columns: 1fr;
                    }
                }
            </style>

            <!-- Summary Cards -->
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div class="glass-card stat-card">
                    <div class="stat-label">Total Invested</div>
                    <div class="stat-value" id="total-invested" style="font-size: 1.5rem; color: var(--accent-green);">
                        Loading...
                    </div>
                    <div class="subtext" style="font-size: 0.8rem;">Lifetime Value</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-label">Total Wasted</div>
                    <div class="stat-value currency-red" id="total-wasted" style="font-size: 1.5rem;">Loading...</div>
                    <div class="subtext" style="font-size: 0.8rem;">Lifetime Loss</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-label">Avg Daily Value</div>
                    <div class="stat-value" id="avg-daily" style="font-size: 1.5rem; color: var(--accent-gold);">
                        Loading...</div>
                    <div class="subtext" style="font-size: 0.8rem;">Consistency Score</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value" id="total-tasks" style="font-size: 1.5rem; color: #4dabf7;">Loading...</div>
                    <div class="subtext" style="font-size: 0.8rem;">Activity Volume</div>
                </div>
            </div>

            <!-- Today's Snapshot -->
            <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">
                Today's
                Snapshot</h3>
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div class="glass-card stat-card" style="border-left: 3px solid var(--accent-green);">
                    <div class="stat-label">Invested Today</div>
                    <div class="stat-value" id="today-invested" style="font-size: 1.5rem; color: var(--accent-green);">
                        Loading...
                    </div>
                    <div class="subtext" style="font-size: 0.8rem;">Growth Focus</div>
                </div>
                <div class="glass-card stat-card" style="border-left: 3px solid #ff4d4d;">
                    <div class="stat-label">Wasted Today</div>
                    <div class="stat-value currency-red" id="today-wasted" style="font-size: 1.5rem;">Loading...</div>
                    <div class="subtext" style="font-size: 0.8rem;">Missed Opportunity</div>
                </div>
                <div class="glass-card stat-card" style="border-left: 3px solid #4dabf7;">
                    <div class="stat-label">Tasks Today</div>
                    <div class="stat-value" id="today-tasks" style="font-size: 1.5rem; color: #4dabf7;">Loading...</div>
                    <div class="subtext" style="font-size: 0.8rem;">Daily Activity</div>
                </div>
            </div>

            <!-- Charts Grid -->

            <!-- Row 1: Daily Trends (Line) -->
            <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1.5rem; height: 350px;">
                <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">
                    Daily Trends
                </h3>
                <div style="height: 280px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Row 2: Time Distribution & Categories -->
            <div class="charts-row-2">
                <!-- Time Distribution (Bar) -->
                <div class="glass-card" style="padding: 1.5rem; height: 350px;">
                    <h3
                        style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">
                        Time
                        Distribution (24h)</h3>
                    <div style="height: 280px;">
                        <canvas id="timeDistChart"></canvas>
                    </div>
                </div>

                <!-- Category Breakdown (Doughnut) -->
                <div class="glass-card" style="padding: 1.5rem; height: 350px;">
                    <h3
                        style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">
                        Category
                        Mix</h3>
                    <div style="height: 280px; display:flex; justify-content:center;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Row 3: Top Tasks -->
            <div class="glass-card" style="padding: 1.5rem;">
                <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">
                    Top
                    Time-Consuming Tasks</h3>

                <div class="leaderboard-container">
                    <table class="leaderboard-table" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--glass-border); text-align:left;">
                                <th style="padding:0.8rem; color:var(--text-secondary);">Task Name</th>
                                <th style="padding:0.8rem; color:var(--text-secondary);">Category</th>
                                <th style="padding:0.8rem; text-align:right; color:var(--text-secondary);">Total Value
                                </th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- JS Loaded -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="static/js/main.js"></script>

    <script>
        let currentRange = '7d';
        let charts = {}; // Store chart instances

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth().then(auth => {
                if (!auth) window.location.href = 'login.html';
                else loadAll();
            });
        });

        function setRange(range) {
            currentRange = range;
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${range}`).classList.add('active');
            loadAll();
        }

        function loadAll() {
            const data = AnalyticsAPI.getSummary(currentRange);
            if (!data) return;

            // Summary
            document.getElementById('total-invested').textContent = '$' + (data.total_invested || 0).toLocaleString();
            document.getElementById('total-wasted').textContent = '$' + (data.total_wasted || 0).toLocaleString();
            document.getElementById('avg-daily').textContent = '$' + (data.avg_daily_investment || 0).toLocaleString();
            document.getElementById('total-tasks').textContent = (data.total_tasks || 0).toLocaleString();

            document.getElementById('today-invested').textContent = '$' + (data.today_invested || 0).toLocaleString();
            document.getElementById('today-wasted').textContent = '$' + (data.today_wasted || 0).toLocaleString();
            document.getElementById('today-tasks').textContent = (data.today_tasks || 0).toLocaleString();

            loadCharts(currentRange);
            loadLeaderboard(currentRange);
        }

        function loadCharts(range) {
            // Destroy existing
            if (charts.trend) charts.trend.destroy();
            if (charts.time) charts.time.destroy();
            if (charts.cat) charts.cat.destroy();

            const tasks = AnalyticsAPI.getData(range); // Raw tasks

            // --- 1. Daily Trend ---
            // Group by day. For 7d/30d/365d we need to show trend over time.
            // For 1d, maybe hourly? Let's stick to daily for now or skipped for 1d.
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            const trendData = processTrend(tasks, range);

            charts.trend = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [
                        {
                            label: 'Invested',
                            data: trendData.invested,
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Wasted',
                            data: trendData.wasted,
                            borderColor: '#ff4d4d',
                            backgroundColor: 'rgba(255, 77, 77, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    },
                    plugins: { legend: { labels: { color: '#ccc' } } }
                }
            });

            // --- 2. Time Dist ---
            // Only if we have hours? For now random mock or simple processing
            const ctxTime = document.getElementById('timeDistChart').getContext('2d');
            charts.time = new Chart(ctxTime, {
                type: 'bar',
                data: {
                    labels: ['00', '04', '08', '12', '16', '20'], // Simplified buckets
                    datasets: [{
                        label: 'Seconds Spent',
                        data: [0, 0, 0, 0, 0, 0], // Placeholders as complex bucket logic in JS is needed
                        backgroundColor: 'rgba(212, 175, 55, 0.6)',
                        borderColor: '#D4AF37',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // --- 3. Category ---
            let cats = { Good: 0, Neutral: 0, Bad: 0 };
            tasks.forEach(t => cats[t.label] = (cats[t.label] || 0) + 1);

            const ctxCat = document.getElementById('categoryChart').getContext('2d');
            charts.cat = new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: ['Good', 'Neutral', 'Bad'],
                    datasets: [{
                        data: [cats.Good, cats.Neutral, cats.Bad],
                        backgroundColor: ['#4caf50', '#888888', '#ff4d4d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#ccc' } } }
                }
            });
        }

        function processTrend(tasks, range) {
            // Sort tasks by date
            // create map date -> {invested, wasted}
            // generate labels
            return { labels: [], invested: [], wasted: [] }; // simplified for now
        }

        function loadLeaderboard() {
            // ... reuse logic ...
        }

        async function exportReport() {
            // ... same PDF logic ...
        }

    </script>
</body>

</html>