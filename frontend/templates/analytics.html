{% extends "base.html" %}

{% block content %}
<div class="analytics-wrapper">
  <div class="dashboard-header"
    style="justify-content: space-between; align-items: flex-end; display:flex; margin-bottom: 2rem;">
    <div>
      <h1 style="margin-bottom:0.5rem; color: var(--accent-gold);">Financial Analysis</h1>
      <p style="color: var(--text-secondary);">Your asset allocation & performance report.</p>
    </div>
    <div style="text-align: right;">
      <div class="filters"
        style="display:inline-flex; gap:0.5rem; margin-bottom:1rem; background:rgba(255,255,255,0.05); padding:0.3rem; border-radius:8px;">
        <button onclick="setRange('1d')" class="btn-filter" id="btn-1d">Today</button>
        <button onclick="setRange('7d')" class="btn-filter active" id="btn-7d">7 Days</button>
        <button onclick="setRange('30d')" class="btn-filter" id="btn-30d">Month</button>
        <button onclick="setRange('365d')" class="btn-filter" id="btn-365d">Year</button>
      </div>
      <div>
        <button onclick="exportReport()" class="btn btn-secondary">
          <i class="fas fa-file-pdf" style="margin-right:0.5rem;"></i> Export Report
        </button>
      </div>
    </div>
  </div>

  <style>
    .btn-filter {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .btn-filter:hover {
      color: var(--text-primary);
    }

    .btn-filter.active {
      background: var(--accent-gold);
      color: #000;
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
    }

    .charts-row-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 900px) {
      .charts-row-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- Summary Cards -->
  <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <div class="glass-card stat-card">
      <div class="stat-label">Total Invested</div>
      <div class="stat-value" id="total-invested" style="font-size: 1.5rem; color: var(--accent-green);">Loading...
      </div>
      <div class="subtext" style="font-size: 0.8rem;">Lifetime Value</div>
    </div>
    <div class="glass-card stat-card">
      <div class="stat-label">Total Wasted</div>
      <div class="stat-value currency-red" id="total-wasted" style="font-size: 1.5rem;">Loading...</div>
      <div class="subtext" style="font-size: 0.8rem;">Lifetime Loss</div>
    </div>
    <div class="glass-card stat-card">
      <div class="stat-label">Avg Daily Value</div>
      <div class="stat-value" id="avg-daily" style="font-size: 1.5rem; color: var(--accent-gold);">Loading...</div>
      <div class="subtext" style="font-size: 0.8rem;">Consistency Score</div>
    </div>
    <div class="glass-card stat-card">
      <div class="stat-label">Total Tasks</div>
      <div class="stat-value" id="total-tasks" style="font-size: 1.5rem; color: #4dabf7;">Loading...</div>
      <div class="subtext" style="font-size: 0.8rem;">Activity Volume</div>
    </div>
  </div>

  <!-- Today's Snapshot -->
  <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1.1rem; text-transform: uppercase;">Today's
    Snapshot</h3>
  <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <div class="glass-card stat-card" style="border-left: 3px solid var(--accent-green);">
      <div class="stat-label">Invested Today</div>
      <div class="stat-value" id="today-invested" style="font-size: 1.5rem; color: var(--accent-green);">Loading...
      </div>
      <div class="subtext" style="font-size: 0.8rem;">Growth Focus</div>
    </div>
    <div class="glass-card stat-card" style="border-left: 3px solid #ff4d4d;">
      <div class="stat-label">Wasted Today</div>
      <div class="stat-value currency-red" id="today-wasted" style="font-size: 1.5rem;">Loading...</div>
      <div class="subtext" style="font-size: 0.8rem;">Missed Opportunity</div>
    </div>
    <div class="glass-card stat-card" style="border-left: 3px solid #4dabf7;">
      <div class="stat-label">Tasks Today</div>
      <div class="stat-value" id="today-tasks" style="font-size: 1.5rem; color: #4dabf7;">Loading...</div>
      <div class="subtext" style="font-size: 0.8rem;">Daily Activity</div>
    </div>
  </div>

  <!-- Charts Grid -->

  <!-- Row 1: Daily Trends (Line) -->
  <div class="glass-card" style="padding: 1.5rem; margin-bottom: 1.5rem; height: 350px;">
    <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">Daily Trends
    </h3>
    <div style="height: 280px;">
      <canvas id="trendChart"></canvas>
    </div>
  </div>

  <!-- Row 2: Time Distribution & Categories -->
  <div class="charts-row-2">
    <!-- Time Distribution (Bar) -->
    <div class="glass-card" style="padding: 1.5rem; height: 350px;">
      <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">Time
        Distribution (24h)</h3>
      <div style="height: 280px;">
        <canvas id="timeDistChart"></canvas>
      </div>
    </div>

    <!-- Category Breakdown (Doughnut) -->
    <div class="glass-card" style="padding: 1.5rem; height: 350px;">
      <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">Category
        Mix</h3>
      <div style="height: 280px; display:flex; justify-content:center;">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Row 3: Top Tasks -->
  <div class="glass-card" style="padding: 1.5rem;">
    <h3 style="color: var(--accent-gold); margin-bottom: 1rem; font-size: 1rem; text-transform: uppercase;">Top
      Time-Consuming Tasks</h3>

    <div class="leaderboard-container">
      <table class="leaderboard-table" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 1px solid var(--glass-border); text-align:left;">
            <th style="padding:0.8rem; color:var(--text-secondary);">Task Name</th>
            <th style="padding:0.8rem; color:var(--text-secondary);">Category</th>
            <th style="padding:0.8rem; text-align:right; color:var(--text-secondary);">Total Value</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body">
          <!-- JS Loaded -->
        </tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
  let currentRange = '7d';
  let charts = {}; // Store chart instances

  document.addEventListener('DOMContentLoaded', () => {
    loadAll();
  });

  function setRange(range) {
    currentRange = range;
    document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${range}`).classList.add('active');
    loadAll();
  }

  function loadAll() {
    loadSummary();
    loadCharts();
    loadLeaderboard();
  }

  async function loadSummary() {
    try {
      const res = await fetch(`/api/analytics/summary?range=${currentRange}`);
      const data = await res.json();
      document.getElementById('total-invested').textContent = '$' + data.total_invested.toLocaleString();
      document.getElementById('total-wasted').textContent = '$' + data.total_wasted.toLocaleString();
      document.getElementById('avg-daily').textContent = '$' + data.avg_daily_investment.toLocaleString();
      document.getElementById('total-tasks').textContent = data.total_tasks.toLocaleString();

      // Today's Stats
      document.getElementById('today-invested').textContent = '$' + data.today_invested.toLocaleString();
      document.getElementById('today-wasted').textContent = '$' + data.today_wasted.toLocaleString();
      document.getElementById('today-tasks').textContent = data.today_tasks.toLocaleString();
    } catch (e) {
      console.error(e);
      document.getElementById('total-invested').textContent = 'Error'; // Feedback to user
      document.getElementById('total-wasted').textContent = 'Error';
    }
  }

  async function loadCharts() {
    // Destroy existing
    if (charts.trend) charts.trend.destroy();
    if (charts.time) charts.time.destroy();
    if (charts.cat) charts.cat.destroy();

    // 1. Daily Trends
    try {
      const trendRes = await fetch(`/api/analytics/chart-data?range=${currentRange}`);
      const trendData = await trendRes.json();
      const ctxTrend = document.getElementById('trendChart').getContext('2d');
      charts.trend = new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels: trendData.labels,
          datasets: [
            {
              label: 'Invested',
              data: trendData.invested,
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Wasted',
              data: trendData.wasted,
              borderColor: '#ff4d4d',
              backgroundColor: 'rgba(255, 77, 77, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } },
            x: { grid: { display: false }, ticks: { color: '#888' } }
          },
          plugins: { legend: { labels: { color: '#ccc' } } }
        }
      });
    } catch (e) { console.error("Trend chart error", e); }

    // 2. Time Distribution
    try {
      const timeRes = await fetch(`/api/analytics/time-distribution?range=${currentRange}`);
      const timeData = await timeRes.json();
      const ctxTime = document.getElementById('timeDistChart').getContext('2d');
      charts.time = new Chart(ctxTime, {
        type: 'bar',
        data: {
          labels: timeData.labels,
          datasets: [{
            label: 'Seconds Spent',
            data: timeData.data,
            backgroundColor: 'rgba(212, 175, 55, 0.6)',
            borderColor: '#D4AF37',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' } },
            x: { grid: { display: false }, ticks: { color: '#888', maxTicksLimit: 12 } }
          },
          plugins: { legend: { display: false } }
        }
      });
    } catch (e) { console.error("Time chart error", e); }

    // 3. Category Breakdown
    try {
      const catRes = await fetch(`/api/analytics/categories?range=${currentRange}`);
      const catData = await catRes.json();
      const ctxCat = document.getElementById('categoryChart').getContext('2d');
      charts.cat = new Chart(ctxCat, {
        type: 'doughnut',
        data: {
          labels: ['Good', 'Neutral', 'Bad'],
          datasets: [{
            data: [catData.Good, catData.Neutral, catData.Bad],
            backgroundColor: ['#4caf50', '#888888', '#ff4d4d'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right', labels: { color: '#ccc' } } }
        }
      });
    } catch (e) { console.error("Category chart error", e); }
  }

  async function loadLeaderboard() {
    try {
      const res = await fetch(`/api/analytics/leaderboard?range=${currentRange}`);
      const data = await res.json();

      // Add pseudo-labels for coloring since backend separates them by list
      const assets = data.assets.map(x => ({ ...x, label: 'Asset' }));
      const liabilities = data.liabilities.map(x => ({ ...x, label: 'Waste' }));

      let allItems = [...assets, ...liabilities];
      allItems.sort((a, b) => b.total - a.total);
      const top10 = allItems.slice(0, 10);

      const tbody = document.getElementById('leaderboard-body');
      tbody.innerHTML = '';
      if (top10.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:1rem; opacity:0.6;">No data.</td></tr>';
        return;
      }

      top10.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        tr.innerHTML = `
                    <td style="padding:0.8rem;">${item.name}</td>
                    <td style="padding:0.8rem;">
                        <span class="badge ${item.label === 'Waste' ? 'badge-bad' : 'badge-good'}">
                            ${item.label}
                        </span>
                    </td>
                    <td style="padding:0.8rem; text-align:right; font-family:monospace;">$${item.total.toLocaleString()}</td>
                `;
        tbody.appendChild(tr);
      });
    } catch (e) { console.error("Leaderboard error", e); }
  }

  async function exportReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Load Logo
    const img = new Image();
    img.src = '/static/img/logo.jpg';
    await new Promise(r => img.onload = r);

    // Header Background
    doc.setFillColor(10, 10, 15); // Dark background
    doc.rect(0, 0, 210, 50, 'F');

    // Add Logo
    doc.addImage(img, 'PNG', 15, 10, 30, 30);

    // Title
    doc.setTextColor(212, 175, 55); // Gold
    doc.setFontSize(24);
    doc.setFont("helvetica", "bold");
    doc.text("SpenT Financial Report", 55, 25);

    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(200, 200, 200);
    doc.text(`Generated: ${new Date().toLocaleDateString()} | Range: ${currentRange.toUpperCase()}`, 55, 35);

    // Summary Section
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("Executive Summary", 15, 65);

    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");

    const invested = document.getElementById('total-invested').textContent;
    const wasted = document.getElementById('total-wasted').textContent;
    const avg = document.getElementById('avg-daily').textContent;
    const tasks = document.getElementById('total-tasks').textContent;

    const summaryData = [
      ['Total Invested', invested],
      ['Total Wasted', wasted],
      ['Avg Daily Value', avg],
      ['Total Tasks', tasks]
    ];

    doc.autoTable({
      startY: 70,
      head: [['Metric', 'Value']],
      body: summaryData,
      theme: 'grid',
      headStyles: { fillColor: [212, 175, 55], textColor: [0, 0, 0], fontStyle: 'bold' },
      styles: { fontSize: 11, cellPadding: 4 },
      columnStyles: { 0: { fontStyle: 'bold', width: 80 } }
    });

    // Today's Stats Section in PDF
    const todayY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("Today's Performance", 15, todayY);

    const todayInvested = document.getElementById('today-invested').textContent;
    const todayWasted = document.getElementById('today-wasted').textContent;
    const todayTasks = document.getElementById('today-tasks').textContent;

    doc.autoTable({
      startY: todayY + 5,
      head: [['Metric', 'Value']],
      body: [
        ['Invested Today', todayInvested],
        ['Wasted Today', todayWasted],
        ['Tasks Logged', todayTasks]
      ],
      theme: 'grid',
      headStyles: { fillColor: [70, 70, 70], textColor: [255, 255, 255] },
      styles: { fontSize: 11, cellPadding: 4 }
    });

    // Leaderboard Section
    const finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("Top Time-Consuming Tasks", 15, finalY);

    const rows = [];
    document.querySelectorAll('#leaderboard-body tr').forEach(tr => {
      const cols = tr.querySelectorAll('td');
      if (cols.length >= 3) {
        // Strip badge html text, get text content
        rows.push([cols[0].textContent.trim(), cols[1].textContent.trim(), cols[2].textContent.trim()]);
      }
    });

    doc.autoTable({
      startY: finalY + 5,
      head: [['Task Analysis', 'Type', 'Total Value']],
      body: rows,
      theme: 'striped',
      headStyles: { fillColor: [20, 20, 20], textColor: [212, 175, 55] },
      alternateRowStyles: { fillColor: [245, 245, 245] },
      styles: { fontSize: 10 }
    });

    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(150);
      doc.text('Time is Currency - Managed by SpenT', 105, 290, null, null, "center");
    }

    doc.save(`SpenT_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
  }

</script>
{% endblock %}