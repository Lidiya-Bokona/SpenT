<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpenT - Calendar</title>
  <link rel="icon" type="image/png" href="static/img/logo.jpg">
  <link rel="stylesheet" href="static/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
</head>

<body>
  <nav class="navbar">
    <div class="logo">
      <div class="hero-logo-animated nav-logo">
        <div class="analog-clock">
          <div class="dollar-sign">$</div>
          <div class="hand hour-hand"></div>
          <div class="hand minute-hand"></div>
        </div>
      </div>
      SpenT
    </div>
    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="calendar.html" class="active">Calendar</a>
      <a href="analytics.html">Analytics</a>
    </div>
  </nav>

  <div class="container">
    <div class="calendar-wrapper">
      <div class="header-section"
        style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 style="margin: 0; color: var(--accent-gold);">Investment Calendar</h2>
          <p style="color: var(--text-secondary); margin-top: 0.5rem;">Track your daily efficiency.</p>
        </div>
        <div class="legend" style="display: flex; gap: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="width: 12px; height: 12px; background: var(--accent-gold); border-radius: 50%;"></span>
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Invested</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="width: 12px; height: 12px; background: #ff4d4d; border-radius: 50%;"></span>
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Wasted</span>
          </div>
        </div>
      </div>

      <div class="glass-card" style="padding: 1.5rem;">
        <div id="calendar"></div>
      </div>
    </div>

    <!-- Side Panel -->
    <div id="day-panel" class="side-panel">
      <div class="panel-header">
        <h3 id="panel-date" style="color: var(--accent-gold); margin: 0; font-size: 1.2rem;">Date</h3>
        <button onclick="closeDayPanel()" class="close-panel-btn">&times;</button>
      </div>
      <div class="panel-content">
        <div class="panel-stats">
          <div class="p-stat">
            <span class="label" style="color: var(--accent-gold);">Invested</span>
            <span class="value currency-gold" id="p-invested">0h 0m</span>
          </div>
          <div class="p-stat">
            <span class="label" style="color: #ff4d4d;">Wasted</span>
            <span class="value currency-red" id="p-wasted">0h 0m</span>
          </div>
        </div>
        <h4
          style="margin-top: 2rem; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:0.8rem; margin-bottom: 1rem;">
          Transactions</h4>
        <div id="panel-tasks" class="panel-task-list"></div>
      </div>
    </div>
    <div id="panel-overlay" class="panel-overlay" onclick="closeDayPanel()"></div>

    <style>
      .fc-theme-standard td,
      .fc-theme-standard th {
        border-color: rgba(255, 255, 255, 0.05);
      }

      .fc-day-today {
        background: rgba(212, 175, 55, 0.05) !important;
      }

      .fc-col-header-cell-cushion {
        color: var(--accent-gold);
        text-transform: uppercase;
        font-weight: 700;
        font-size: 0.85rem;
        letter-spacing: 1px;
      }

      .fc-button-primary {
        background: transparent !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
        color: #aaa !important;
        text-transform: uppercase;
      }

      .fc-button-active {
        color: var(--accent-gold) !important;
        border-color: var(--accent-gold) !important;
        background: rgba(212, 175, 55, 0.1) !important;
      }

      .fc-event {
        cursor: pointer;
      }

      .side-panel {
        position: fixed;
        top: 0;
        right: -450px;
        width: 400px;
        height: 100vh;
        background: #0a0a0a;
        border-left: 1px solid var(--accent-gold);
        z-index: 2000;
        transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
      }

      .side-panel.active {
        right: 0;
      }

      .panel-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 215, 0, 0.05);
      }

      .close-panel-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.8rem;
        cursor: pointer;
        line-height: 1;
      }

      .close-panel-btn:hover {
        color: var(--accent-gold);
      }

      .panel-content {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
      }

      .panel-stats {
        display: flex;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.03);
        padding: 1.2rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .p-stat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .p-stat .label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 0.3rem;
      }

      .p-stat .value {
        font-size: 1.2rem;
        font-weight: 600;
        font-family: 'Courier New', monospace;
      }

      .panel-task-item {
        padding: 1rem;
        margin-bottom: 0.8rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border-left: 3px solid #555;
        transition: transform 0.2s;
      }

      .panel-task-item:hover {
        transform: translateX(5px);
        background: rgba(255, 255, 255, 0.05);
      }

      .panel-task-item.Good {
        border-left-color: var(--accent-gold);
      }

      .panel-task-item.Bad {
        border-left-color: #ff4d4d;
      }

      .panel-task-item.Neutral {
        border-left-color: #888;
      }

      .panel-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(2px);
        z-index: 1999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .panel-overlay.active {
        display: block;
        opacity: 1;
      }
    </style>
  </div>

  <script src="static/js/main.js"></script>
  <script>
    function getStoredTasks() {
      return JSON.parse(localStorage.getItem('spent_tasks') || '[]');
    }

    function timeToSec(t) {
      const [h, m] = t.split(':').map(Number);
      return h * 3600 + m * 60;
    }

    function formatDur(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      return `${h}h ${m}m`;
    }

    let currentEvents = [];

    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const allTasks = getStoredTasks();
      currentEvents = allTasks;

      // Group by date
      const days = {};
      allTasks.forEach(t => {
        if (!days[t.date]) days[t.date] = { invested: 0, wasted: 0 };
        const dur = timeToSec(t.end_time) - timeToSec(t.start_time);
        if (t.label === 'Good' || t.label === 'Neutral') days[t.date].invested += dur;
        else days[t.date].wasted += dur;
      });

      const events = [];
      Object.keys(days).forEach(date => {
        const d = days[date];
        if (d.invested > 0) {
          events.push({
            title: formatDur(d.invested),
            start: date,
            extendedProps: { type: 'Invested', val: d.invested },
            classNames: ['evt-invested'],
            textColor: '#D4AF37',
            backgroundColor: 'rgba(212, 175, 55, 0.15)'
          });
        }
        if (d.wasted > 0) {
          events.push({
            title: formatDur(d.wasted),
            start: date,
            extendedProps: { type: 'Wasted', val: d.wasted },
            classNames: ['evt-wasted'],
            textColor: '#ff4d4d',
            backgroundColor: 'rgba(255, 77, 77, 0.15)'
          });
        }
      });

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
        themeSystem: 'standard',
        height: 'auto',
        contentHeight: 650,
        events: events,
        dateClick: function (info) { openDayPanel(info.dateStr); },
        eventClick: function (info) { openDayPanel(info.event.startStr); },
        eventContent: function (arg) {
          const color = arg.event.textColor;
          const bg = arg.event.backgroundColor;
          const title = arg.event.title;
          const type = arg.event.extendedProps.type;
          return {
            html: `
              <div style="background:${bg}; border-left:3px solid ${color}; padding:2px 4px; margin-bottom:2px; border-radius:3px;">
                <div style="font-size:0.75rem; font-weight:600; color:${color}; display:flex; justify-content:space-between;">
                    <span>${type}</span><span>${title}</span>
                </div>
              </div>
            `};
        }
      });
      calendar.render();
    });

    function openDayPanel(dateStr) {
      document.getElementById('panel-date').textContent = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      const tasks = currentEvents.filter(t => t.date === dateStr).sort((a, b) => a.start_time.localeCompare(b.start_time));

      const list = document.getElementById('panel-tasks');
      list.innerHTML = '';

      let inv = 0; let wst = 0;
      if (tasks.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#888; margin-top:2rem;">No logs.</div>';
      } else {
        tasks.forEach(t => {
          const dur = timeToSec(t.end_time) - timeToSec(t.start_time);
          if (t.label === 'Good' || t.label === 'Neutral') inv += dur; else wst += dur;

          const el = document.createElement('div');
          el.className = `panel-task-item ${t.label}`;
          el.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong style="color:#fff;">${t.name}</strong>
                    <span style="font-family:monospace; color:#ccc;">${formatDur(dur)}</span>
                </div>
                <div style="font-size:0.8rem; color:#888; margin-top:0.2rem;">
                    <span class="badge ${t.label === 'Good' ? 'badge-good' : t.label === 'Bad' ? 'badge-bad' : 'badge-neutral'}">${t.label}</span>
                    <span style="float:right;">${t.start_time} - ${t.end_time}</span>
                </div>
             `;
          list.appendChild(el);
        });
      }

      document.getElementById('p-invested').textContent = formatDur(inv);
      document.getElementById('p-wasted').textContent = formatDur(wst);

      document.getElementById('day-panel').classList.add('active');
      document.getElementById('panel-overlay').classList.add('active');
    }

    window.closeDayPanel = function () {
      document.getElementById('day-panel').classList.remove('active');
      document.getElementById('panel-overlay').classList.remove('active');
    }
  </script>
</body>

</html>