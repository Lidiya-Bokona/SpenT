{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
  <div class="user-greeting">
    <h2 style="margin:0;">Welcome back, <span style="color: var(--accent-gold);">{{ current_user.username }}</span>.
    </h2>
    <div id="current-datetime" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">Loading...
    </div>
  </div>
</div>

<div class="balance-card glass-card" style="margin-bottom: 2rem;">
  <div class="balance-label">Remaining Balance</div>
  <div class="countdown" id="countdown" data-remaining="{{ remaining }}">
    $<span id="money-counter">{{ remaining }}</span>
  </div>
  <p class="subtext">Time is your most valuable asset.</p>
</div>

<div class="metrics-row">
  <div class="metric-card glass-card">
    <div class="metric-info">
      <h4>Invested Today</h4>
      <div class="metric-value currency-gold">$<span id="invested-today">{{ invested }}</span></div>
      <div id="invested-duration" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0h 0m</div>
    </div>
    <div class="trend-icon trend-up">ðŸ“ˆ</div>
  </div>
  <div class="metric-card glass-card">
    <div class="metric-info">
      <h4>Wasted Today</h4>
      <div class="metric-value currency-red">$<span id="wasted-today">{{ wasted }}</span></div>
      <div id="wasted-duration" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">0h 0m</div>
    </div>
    <div class="trend-icon trend-down">ðŸ“‰</div>
  </div>
</div>

<div class="dashboard-grid">
  <div class="tasks-section" style="width: 100%;">
    <div class="section-header"
      style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom:1px solid var(--glass-border); padding-bottom:1rem;">
      <h3>Today's Ledger</h3>
      <button class="btn btn-primary" onclick="openByModal()">+ Add Task</button>
    </div>

    <div class="task-list" id="task-list">
      <!-- Tasks will be loaded here via JS (main.js) calling /api/dashboard -->
      <!-- Initial render from server can be avoided or kept as fallback, but main.js clears it. -->
      <p style="text-align:center; color:var(--text-secondary);">Loading transactions...</p>
    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="task-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title" style="margin:0; font-size:1.5rem; color: var(--accent-gold);">New Transaction</h3>
      <button class="close-modal-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <form id="modal-task-form" class="modern-form">
      <input type="hidden" id="task-id">
      <h4 id="form-message" style="color: red; display: none; margin-bottom: 1rem;"></h4>

      <div class="form-group">
        <label>Task Name</label>
        <input type="text" id="m-task-name" placeholder="E.g. Deep Work" required>
      </div>

      <div class="form-group" style="display: flex; gap: 1rem;">
        <div style="flex: 1;">
          <label>Start Time</label>
          <input type="time" id="m-task-start" required>
        </div>
        <div style="flex: 1;">
          <label>End Time</label>
          <input type="time" id="m-task-end" required>
        </div>
      </div>

      <div class="form-group">
        <label>Task Type (Category)</label>
        <div class="category-selector">
          <input type="radio" name="category" id="cat-good" value="Good" checked>
          <label for="cat-good" class="cat-option option-good">
            <i class="fas fa-arrow-trend-up"></i>
            <span>Investment</span>
          </label>

          <input type="radio" name="category" id="cat-neutral" value="Neutral">
          <label for="cat-neutral" class="cat-option option-neutral">
            <i class="fas fa-minus"></i>
            <span>Neutral</span>
          </label>

          <input type="radio" name="category" id="cat-bad" value="Bad">
          <label for="cat-bad" class="cat-option option-bad">
            <i class="fas fa-arrow-trend-down"></i>
            <span>Expense</span>
          </label>
        </div>
        <!-- Hidden select to maintain compatibility with existing JS if needed, or update JS to read radios -->
        <select id="m-task-label" style="display:none;">
          <option value="Good">Investment</option>
          <option value="Neutral">Neutral</option>
          <option value="Bad">Expense</option>
        </select>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea id="m-task-desc" rows="2" placeholder="Add details (optional)..."></textarea>
      </div>

      <div class="form-section-divider"></div>

      <div class="form-group">
        <div class="routine-toggle-wrapper">
          <label class="switch-label">
            <span style="font-weight:600; font-size:0.95rem;">Routine Task</span>
            <span style="font-size:0.8rem; color:var(--text-secondary); display:block;">Repeat this transaction
              automatically</span>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="m-is-routine">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="form-group hidden fade-in" id="routine-options">
        <label style="margin-bottom:0.5rem; display:block;">Frequency</label>
        <div class="recurrence-options">
          <!-- Hidden input to store value -->
          <input type="hidden" id="m-recurrence-type" value="Daily">

          <button type="button" class="recurrence-btn active" onclick="setRecurrence('Daily')"
            data-value="Daily">Daily</button>
          <button type="button" class="recurrence-btn" onclick="setRecurrence('Weekdays')"
            data-value="Weekdays">Weekdays</button>
          <button type="button" class="recurrence-btn" onclick="setRecurrence('Weekends')"
            data-value="Weekends">Weekends</button>
          <button type="button" class="recurrence-btn" onclick="setRecurrence('Custom')"
            data-value="Custom">Custom</button>
        </div>

        <div class="custom-days-selector hidden" id="custom-days-container" style="margin-top:1rem;">
          <div class="day-btn" onclick="toggleDay(this)" data-day="Mon">M</div>
          <div class="day-btn" onclick="toggleDay(this)" data-day="Tue">T</div>
          <div class="day-btn" onclick="toggleDay(this)" data-day="Wed">W</div>
          <div class="day-btn" onclick="toggleDay(this)" data-day="Thu">T</div>
          <div class="day-btn" onclick="toggleDay(this)" data-day="Fri">F</div>
          <div class="day-btn" onclick="toggleDay(this)" data-day="Sat">S</div>
          <div class="day-btn" onclick="toggleDay(this)" data-day="Sun">S</div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary full-width" style="width: 100%; margin-top: 1rem;">Save
        Transaction</button>
    </form>
  </div>
</div>


<script>
  // Helper to sync visual category selection with hidden select
  document.addEventListener('DOMContentLoaded', function () {
    const radioButtons = document.querySelectorAll('input[name="category"]');
    const hiddenSelect = document.getElementById('m-task-label');

    radioButtons.forEach(radio => {
      radio.addEventListener('change', function () {
        if (this.checked) {
          hiddenSelect.value = this.value;
        }
      });
    });

    // Reverse sync (if editing and setting select value)
    // You might need to add this logic in your main.js where you populate the modal for editing
  });
</script>
{% endblock %}